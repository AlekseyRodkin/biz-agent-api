# RUNBOOK: MCP SSH Operations

## Source of Truth (единственный допустимый VPS)

| Параметр | Значение |
|----------|----------|
| **VPS IP** | `5.129.224.93` |
| **SSH User** | `root` |
| **Project Path** | `/opt/biz-agent-api-git/biz-agent-api` |
| **PM2 Process** | `biz-agent-api` |
| **Port** | `8000` |
| **MCP Tool** | `mcp__ssh-vps__exec` |

**Подтверждено через MCP:** 2026-01-29

---

## СТРОГИЕ ПРАВИЛА

### При любой SSH операции — ОБЯЗАТЕЛЬНО:

1. **Проверить хост через MCP:**
   ```bash
   hostname -I | awk '{print $1}'
   ```
   Ожидаемый результат: `5.129.224.93`

2. **Если IP ≠ 5.129.224.93:**
   - **СТОП** — не выполнять никаких действий
   - Сообщить пользователю о несоответствии
   - Запросить подтверждение или исправление MCP конфигурации

### ЗАПРЕЩЕНО:

- Использовать IP ≠ Source of Truth без явного подтверждения пользователя
- "Угадывать" или "пробовать" другие IP адреса
- Продолжать работу при несоответствии хоста

### При нахождении другого IP в документации/коде:

Любой IP ≠ `5.129.224.93` в репозитории считается **устаревшим/ошибочным**.

Действия:
1. Сообщить пользователю о найденном несоответствии
2. Предложить заменить на Source of Truth
3. Не использовать найденный IP без подтверждения

---

## Типовые операции

### Deploy новой версии

```bash
# 1. Pull код
cd /opt/biz-agent-api-git/biz-agent-api && git pull origin main

# 2. Restart сервиса
pm2 restart biz-agent-api

# 3. Проверка
curl -s http://127.0.0.1:8000/health
```

### Проверка статуса

```bash
pm2 list
pm2 logs biz-agent-api --lines 20
```

### Проверка версии

```bash
curl -s http://127.0.0.1:8000/health | python3 -m json.tool
```

---

## Troubleshooting

### MCP не отвечает

1. Проверить подключение: `echo test`
2. Проверить хост: `hostname -I`
3. Если хост не тот — сообщить пользователю

### Сервис не запускается

```bash
pm2 logs biz-agent-api --lines 50
cat /opt/biz-agent-api-git/biz-agent-api/.env  # проверить env
```

---

## Безопасность

**См. полные правила:** `docs/SECURITY_RULES.md`

### Краткие правила:

1. **НИКОГДА** не выводить секреты в stdout/логи/отчёты
2. Токены показывать как `REDACTED` или первые 4 символа + `...`
3. Перед коммитом: `./scripts/scan_secrets.sh`
4. При утечке: `./scripts/rotate_admin_token.sh && ./scripts/swap_admin_token.sh`

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-29 | Создан runbook, Source of Truth: 5.129.224.93 |
| 2026-01-29 | Добавлена секция Безопасность |

---

*Этот файл — единственный источник правды для SSH операций.*
